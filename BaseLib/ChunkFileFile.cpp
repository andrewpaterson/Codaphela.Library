#include "Logger.h"
#include "ChunkFile.h"
#include "ChunkFileFile.h"


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CChunkFileFile::Init(CChunkFile* pcChunkFile)
{
	CAbstractFile::Init();
	mpcChunkFile = pcChunkFile;
	miChunkStart = 0;
	miChunkSize = 0;
	mbEndOfFile = TRUE;
	mbWriteMode = FALSE;
	mbReadMode = FALSE;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CChunkFileFile::Kill(void)
{
	mpcChunkFile = NULL;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
BOOL CChunkFileFile::Open(EFileMode eMode)
{
	if (eMode == EFM_Read)
	{
		miChunkSize = mpcChunkFile->ChunkSize();
		miChunkStart = mpcChunkFile->ChunkStart();
		mbEndOfFile = TRUE;
		mbReadMode = TRUE;
		return TRUE;
	}
	else if (eMode == EFM_Write_Create)
	{
		miChunkSize = -1;
		miChunkStart = mpcChunkFile->ChunkStart();
		mbEndOfFile = FALSE;
		mbWriteMode = TRUE;
		return TRUE;
	}

	return FALSE;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
BOOL CChunkFileFile::Close(void)
{
	miChunkStart = 0;
	miChunkSize = 0;
	mbEndOfFile = TRUE;
	mbWriteMode = FALSE;
	mbReadMode = FALSE;
	return TRUE;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
filePos CChunkFileFile::Read(void* pvBuffer, filePos iSize, filePos iCount)
{
	filePos		iRemain;
	filePos		iReadSize;

	if (!mbReadMode)
	{
		return 0;
	}

	iRemain = miChunkSize - Tell();

	iReadSize = iSize * iCount;

	if (iRemain >= iReadSize)
	{
		return mpcChunkFile->Read(pvBuffer, iSize, iCount);
	}
	else
	{
		iCount = iRemain / iSize;
		mbEndOfFile = TRUE;
		return mpcChunkFile->Read(pvBuffer, iSize, iCount);
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
BOOL CChunkFileFile::Seek(filePos iOffset, EFileSeekOrigin iSeekOrigin)
{
	if (mbReadMode)
	{
		if (iSeekOrigin == EFSO_SET)
		{
			if (iOffset < 0)
			{
				iOffset = 0;
			}
			if (iOffset > miChunkSize)
			{
				iOffset = miChunkSize;
				mbEndOfFile = TRUE;
			}
			else
			{
				mbEndOfFile = FALSE;
			}

			return mpcChunkFile->Seek(miChunkStart + iOffset, EFSO_SET);
		}
	}
	return FALSE;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
filePos CChunkFileFile::Write(const void* pvBuffer, filePos iSize, filePos iCount)
{
	if (!mbWriteMode)
	{
		return FALSE;
	}

	return mpcChunkFile->Write(pvBuffer, iSize, iCount);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
filePos CChunkFileFile::Tell(void)
{
	filePos iPos;

	iPos = mpcChunkFile->GetFilePos() - miChunkStart;

	if (mbReadMode)
	{
		if (iPos > miChunkSize)
		{
			iPos = miChunkSize;
		}
	}

	return iPos;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
BOOL CChunkFileFile::IsOpen(void)
{
	return mbReadMode || mbWriteMode;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
filePos CChunkFileFile::Size(void)
{
	if (mbReadMode)
	{
		return miChunkSize;
	}
	else
	{
		return Tell();
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
BOOL CChunkFileFile::Truncate(filePos iSize)
{
	return gcLogger.Error2(__METHOD__, " Cannot truncate Chunk Files.", NULL);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
BOOL CChunkFileFile::Flush(void)
{
	return FALSE;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
BOOL CChunkFileFile::Delete(void)
{
	return FALSE;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
char* CChunkFileFile::GetFileName(void)
{
	return NULL;
}

