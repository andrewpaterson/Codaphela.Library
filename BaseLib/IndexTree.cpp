#include "Logger.h"
#include "StackMemory.h"
#include "IndexTree.h"


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CIndexTree::Init(CLifeInit<CMallocator> cMalloc, EIndexKeyReverse eKeyReverse, size tSizeofNode, size tSizeofDataNode, size tSizeofNodePtr, size iMaxDataSize, size iMaxKeySize, CLifeInit<CIndexTreeDataOrderer> cDataOrderer)
{
	bool bResult;

	cMalloc.ConfigureLife(&mcMallocLife, &mpcMalloc);

	meReverseKey = eKeyReverse;
	mtSizeofNode = tSizeofNode;
	mtSizeofDataNode = tSizeofDataNode;
	mtSizeofNodePtr = tSizeofNodePtr;
	bResult = true;
	if (iMaxKeySize > MAX_KEY_SIZE)
	{
		gcLogger.Error2(__METHOD__, " Max Key size [", IntToString(iMaxKeySize), "] must be positive and <= [", IntToString(MAX_KEY_SIZE), "].", NULL);
		iMaxKeySize = MAX_KEY_SIZE;
		bResult = false;
	}
	if (iMaxDataSize > MAX_DATA_SIZE)
	{
		gcLogger.Error2(__METHOD__, " Data size [", IntToString(iMaxDataSize), "] must be positive and <= [", IntToString(MAX_DATA_SIZE), "].", NULL);
		iMaxDataSize = MAX_DATA_SIZE;
		bResult = false;
	}
	miMaxDataSize = iMaxDataSize;
	miMaxKeySize = iMaxKeySize;

	cDataOrderer.ConfigureLife(&mcDataOrdererLife, &mpcDataOrderer);
	if (mpcDataOrderer)
	{
		mpcDataOrderer->SetIndexTree(this);
	}
	return bResult;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CIndexTree::Kill(void)
{
	mcDataOrdererLife.Kill();
	mcMallocLife.Kill();
	return true;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void* CIndexTree::Malloc(size uiSize)
{
	return mpcMalloc->Malloc(uiSize);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CIndexTree::Free(void* pv)
{
	mpcMalloc->Free(pv);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void* CIndexTree::Realloc(void* pv, size uiSize)
{
	return mpcMalloc->Realloc(pv, uiSize);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
size CIndexTree::SizeofNode(void)
{
	return mtSizeofNode;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
size CIndexTree::SizeofDataNode(void)
{
	return mtSizeofDataNode;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
size CIndexTree::SizeofNodePtr(void)
{
	return mtSizeofNodePtr;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CIndexTree::FreeNode(CIndexTreeNode* pcNode)
{
	Free(pcNode);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CIndexTree::ValidatePut(size iKeySize, size iDataSize)
{
	if (iKeySize > miMaxKeySize)
	{
		gcLogger.Error2(__METHOD__, "Key size [", SizeToString(iKeySize), "] must be positive and <= [", SizeToString(miMaxKeySize), "].", NULL);
		return false;
	}
	if (iDataSize > miMaxDataSize)
	{
		gcLogger.Error2(__METHOD__, "Data size [", SizeToString(iDataSize), "] must be positive and <= [", SizeToString(miMaxDataSize), "].", NULL);
		return false;
	}
	return true;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CIndexTree::InsertReorderData(CIndexTreeNode* pcNode)
{
	if (mpcDataOrderer)
	{
		mpcDataOrderer->New(pcNode->GetNodeData());
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CIndexTree::GetReorderData(CIndexTreeNode* pcNode)
{
	if (mpcDataOrderer)
	{
		mpcDataOrderer->Get(pcNode->GetNodeData());
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CIndexTree::PutReorderData(CIndexTreeNode* pcNode)
{
	if (mpcDataOrderer)
	{
		mpcDataOrderer->Put(pcNode->GetNodeData());
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CIndexTree::RemoveReorderData(CIndexTreeNode* pcNode)
{
	if (mpcDataOrderer)
	{
		mpcDataOrderer->Remove(pcNode->GetNodeData());
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CIndexTree::HasKeyReorderData(CIndexTreeNode* pcNode)
{
	if (mpcDataOrderer)
	{
		mpcDataOrderer->HasKey(pcNode->GetNodeData());
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
size CIndexTree::CalculateRootNodeSize(void)
{
	return CalculateNodeSize(MAX_UCHAR + 1, 0);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
size CIndexTree::CalculateNodeSize(size iRequiredIndices, size iDataSize)
{
	if (iDataSize == 0)
	{
		return SizeofNode() + iRequiredIndices * SizeofNodePtr();
	}
	else
	{
		return SizeofDataNode() + iDataSize + iRequiredIndices * SizeofNodePtr();
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
EIndexKeyReverse CIndexTree::ReverseKeys(void)
{
	return meReverseKey;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CIndexTree::StartKey(size* pi, size iKeySize)
{
	if (meReverseKey == IKR_No)
	{
		*pi = 0;
		return iKeySize != 0;
	}
	else if (meReverseKey == IKR_Yes)
	{
		if (iKeySize == 0)
		{
			*pi = 0;;
			return false;
		}
		else
		{
			*pi = iKeySize - 1;
			return true;
		}
	}
	else
	{
		gcLogger.Error2(__METHOD__, " Don't know how to start key traversal for key direction [IKR_Unknown].", NULL);
		return false;
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CIndexTree::LoopKey(size* pi, size iKeySize)
{
	if (meReverseKey == IKR_No)
	{
		if (iKeySize == 0)
		{
			return false;
		}
		else
		{
			(*pi)++;
			return *pi < iKeySize;
		}
	}
	else if (meReverseKey == IKR_Yes)
	{
		if ((*pi == 0) || (iKeySize == 0))
		{
			return false;;
		}
		else
		{
			(*pi)--;
			return true;
		}
	}
	else
	{
		gcLogger.Error2(__METHOD__, " Don't know how to loop key traversal for key direction [IKR_Unknown].", NULL);
		return false;
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
CIndexTreeNode* CIndexTree::GetNodeForDataNode(CIndexTreeDataNode* pcDataNode)
{
	return (CIndexTreeNode*)RemapSinglePointer(pcDataNode, -(ptrdiff_t)mtSizeofNode);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
CIndexTreeNode* CIndexTree::GetNodeForData(void* pvData)
{
	return (CIndexTreeNode*)RemapSinglePointer(pvData, -(ptrdiff_t)mtSizeofDataNode);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void* CIndexTree::GetDataForDataNode(CIndexTreeDataNode* pcDataNode)
{
	return RemapSinglePointer(pcDataNode, (mtSizeofDataNode - mtSizeofNode));
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void* CIndexTree::GetDataForNode(CIndexTreeNode* pcNode)
{
	return RemapSinglePointer(pcNode, mtSizeofDataNode);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CIndexTree::GetNodeKey(CIndexTreeNode* pcNode, CArrayChar* pacKey)
{
	size			iNodeSize;
	CStackMemory<>	cTemp;
	char*			szKey;

	if (pcNode != NULL)
	{
		iNodeSize = GetNodeKeySize(pcNode);
		szKey = (char*)cTemp.Init(iNodeSize);
		GetNodeKey(pcNode, (uint8*)szKey, iNodeSize);

		pacKey->Add(szKey, iNodeSize);

		cTemp.Kill();
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
CIndexTreeDataOrderer* CIndexTree::GetDataOrderer()
{
	return mpcDataOrderer;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
CMallocator* CIndexTree::GetMallocator()
{
	return mpcMalloc;
}

