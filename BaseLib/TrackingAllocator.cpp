#include "PointerFunctions.h"
#include "TrackingAllocator.h"


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CTrackingAllocator::Init(CMallocator* pcAlloc)
{
	mpcAlloc = pcAlloc;
	mapv.Init(sizeof(void*), &ComparePtrPtr);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CTrackingAllocator::Kill(void)
{
	mapv.Kill();
	mpcAlloc = NULL;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
int CTrackingAllocator::AllocatedCount(void)
{
	return mapv.NumElements();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void* CTrackingAllocator::Malloc(size uiSize)
{
	void*	pv;

	pv = mpcAlloc->Malloc(uiSize);
	mapv.Add(&pv);

	return pv;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void* CTrackingAllocator::Realloc(void* pv, size uiSize)
{
	void*	pvNew;

	pvNew = mpcAlloc->Realloc(pv, uiSize);
	if (pvNew != pv)
	{
		mapv.Remove(&pv);
	}
	mapv.Add(&pvNew);

	return pvNew;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CTrackingAllocator::Free(void* pv)
{
	bool	bFreed;

	bFreed = mpcAlloc->Free(pv);
	if (bFreed)
	{
		bFreed = mapv.Remove(&pv);
	}
	return bFreed;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
const char* CTrackingAllocator::ClassName(void)
{
	return mpcAlloc->ClassName();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
size CTrackingAllocator::ClassSize(void)
{
	return mpcAlloc->ClassSize();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CTrackingAllocator::IsLocal(void)
{
	return mpcAlloc->IsLocal();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
size CTrackingAllocator::SizeOffset(void)
{
	return mpcAlloc->SizeOffset();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
const char* CTrackingAllocator::ShortName(void)
{
	return ClassName();
}


