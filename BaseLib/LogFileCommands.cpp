#include "FileUtil.h"
#include "PointerRemapper.h"
#include "FastMemcpy.h"
#include "LogFileCommands.h"

//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CLogFileCommand::Init(ELogFileCommand eCommand)
{
	this->eCommand = eCommand;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CLogFileCommand::IsWrite(void)
{
	return eCommand == LFC_Write;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CLogFileCommand::IsOpen(void)
{
	return eCommand == LFC_Open;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CLogFileCommand::IsClose(void)
{
	return eCommand == LFC_Close;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CLogFileCommand::IsDelete(void)
{
	return eCommand == LFC_Delete;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
char* CLogFileCommand::GetType(void)
{
	switch (eCommand)
	{
	case LFC_Write:
		return "Write";
	case LFC_Open:
		return "Open";
	case LFC_Close:
		return "Close";
	case LFC_Delete:
		return "Delete";
	default:
		return NULL;
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CLogFileCommandOpen::Init(EFileMode eMode)
{
	CLogFileCommand::Init(LFC_Open);
	this->eMode = eMode;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CLogFileCommandOpen::Open(CAbstractFile* pcFile)
{
	bool		bResult;
	CFileUtil	cFileUtil;
	char*		szFilename;

	if (IsFileModeCreate(eMode))
	{
		szFilename = pcFile->GetFilename();
		if (szFilename)
		{
			cFileUtil.TouchDir(szFilename, true);
		}
	}

	bResult = pcFile->Open(eMode);
	return bResult;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CLogFileCommandWrite::Init(filePos iPosition, filePos iSize)
{
	CLogFileCommand::Init(LFC_Write);
	this->iPosition = iPosition;
	this->iSize = iSize;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CLogFileCommandWrite::Init(filePos iPosition, void* pvSource, filePos iSize)
{
	void*					pvData;

	Init(iPosition, iSize);

	pvData = RemapSinglePointer(this, sizeof(CLogFileCommandWrite));
	memcpy_fast(pvData, (void*)pvSource, (int)(iSize));
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CLogFileCommandWrite::Write(CAbstractFile* pcFile)
{
	void*		pvData;
	filePos		iWritten;

	pcFile->Seek(iPosition, EFSO_SET);
	pvData = GetData();

	iWritten = pcFile->Write(pvData, iSize, 1);
	if (iWritten != 1)
	{
		return false;
	}
	else
	{
		return true;
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void* CLogFileCommandWrite::GetData(void)
{
	return RemapSinglePointer(this, sizeof(CLogFileCommandWrite));
}



//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CLogFileCommandClose::Init(void)
{
	CLogFileCommand::Init(LFC_Close);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CLogFileCommandClose::Close(CAbstractFile* pcFile)
{
	bool bResult;

	//bResult = pcFile->Flush();
	bResult = pcFile->Close();
	return bResult;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CLogFileCommandDelete::Init(void)
{
	CLogFileCommand::Init(LFC_Delete);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CLogFileCommandDelete::Delete(CAbstractFile* pcFile)
{
	bool bResult;

	bResult = pcFile->Delete();
	return bResult;
}

