#include "BaseLib/ChunkFileFile.h"
#include "Objects.h"
#include "ObjectConverterNative.h"
#include "ObjectFileGeneral.h"
#include "ObjectReaderChunkFile.h"
#include "ObjectSourceChunked.h"


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
BOOL CObjectSourceChunked::Init(CObjectConverter* pcConverter, CAbstractFile* pcFile, char* szFileName)
{
	CObjectMultipleSource::Init(pcConverter, pcFile, szFileName);

	mcChunkFile.Init(mpcFile);
	ReturnOnFalse(mcChunkFile.ReadOpen());
	ReturnOnFalse(ReadNames());

	mpcReader = NULL;
	return mcChunkFile.StackDepth() == 1;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CObjectSourceChunked::Kill(void)
{
	mcChunkFile.ReadClose();
	mcChunkFile.Kill();

	CObjectMultipleSource::Kill();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
BOOL CObjectSourceChunked::ReadNames(void)
{
	SChunkFileNameIterator	sIter;
	char*					szName;

	szName = mcChunkFile.StartNameIteration(&sIter);
	while (szName)
	{
		if (!sIter.szValue.StartsWith(OBJECT_UNNAMED_FILE))
		{
			mcNames.Add(szName);
		}
		szName = mcChunkFile.IterateName(&sIter);
	}
	mcChunkFile.StopIteration(&sIter);


	mcNames.QuickSort(TRUE);

	return TRUE;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
CPointerObject CObjectSourceChunked::Convert(char* szFullName)
{
	CPointerObject			cPointer;

	mpcReader = UMalloc(CObjectReaderChunkFile);
	mpcReader->Init(&mcChunkFile);

	cPointer = mpcConverter->Convert(this, szFullName);
	mpcReader->Kill();

	return cPointer;
}

//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
BOOL CObjectSourceChunked::Contains(char* szFullName)
{
	return CObjectMultipleSource::Contains(szFullName);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
BOOL CObjectSourceChunked::IsChunked(void)
{
	return TRUE;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
BOOL CObjectSourceChunked::IsNative(void)
{
	return TRUE; 
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
CObjectReader* CObjectSourceChunked::GetReader(void)
{
	return mpcReader;
}

