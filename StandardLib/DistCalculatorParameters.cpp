#include "EmbeddedObject.h"
#include "DistCalculatorParameters.h"


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CDistCalculatorParameters::Init(void)
{
	macExpectedDists.Init(1024);
	mapcLowestFroms.Init(1024);
	mapcUnattched.Init(1024);
	mapcDetachedFromRoot.Init(1024);
	mapcCompletelyDetached.Init(1024);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CDistCalculatorParameters::Kill(void)
{
	mapcCompletelyDetached.Kill();
	mapcDetachedFromRoot.Kill();
	mapcUnattched.Kill();
	mapcLowestFroms.Kill();
	macExpectedDists.Kill();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CDistCalculatorParameters::AddExpectedDist(CBaseObject* pcObject, int iExpectedDist)
{
	//This method is never called with an iExpectedDist less than ROOT_DIST_TO_ROOT

	SDistToRoot*	psDistToRoot;

	psDistToRoot = GetExpectedDist(pcObject);

	if (!psDistToRoot)
	{
		psDistToRoot = macExpectedDists.Add();
		psDistToRoot->iExpectedDist = iExpectedDist;
		psDistToRoot->pcObject = pcObject;
	}
	else
	{
		if (psDistToRoot->iExpectedDist > iExpectedDist)
		{
			psDistToRoot->iExpectedDist = iExpectedDist;
		}
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CDistCalculatorParameters::AddUnattached(CBaseObject* pcObject)
{
	mapcUnattched.Add(&pcObject);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
SDistToRoot* CDistCalculatorParameters::GetExpectedDist(CBaseObject* pcObject)
{
	int				i;
	SDistToRoot*	psDistToRoot;

	for (i = 0; i < macExpectedDists.NumElements(); i++)
	{
		psDistToRoot = macExpectedDists.Get(i);
		if (psDistToRoot->pcObject == pcObject)
		{
			return psDistToRoot;
		}
	}

	return NULL;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
BOOL CDistCalculatorParameters::ContainsUnattached(CBaseObject* pcObject)
{
	int				i;
	CBaseObject*	pcCurrent;

	for (i = 0; i < mapcUnattched.NumElements(); i++)
	{
		pcCurrent = *mapcUnattched.Get(i);
		if (pcCurrent == pcObject)
		{
			return TRUE;
		}
	}

	return FALSE;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
SDistToRoot* CDistCalculatorParameters::GetLowest(void)
{
	int				i;
	int				iMinDist;
	SDistToRoot*	pcMinDistToRoot;
	SDistToRoot*	psDistToRoot;

	iMinDist = MAX_DIST_TO_ROOT;
	pcMinDistToRoot = NULL;

	for (i = 0; i < macExpectedDists.NumElements(); i++)
	{
		psDistToRoot = macExpectedDists.Get(i);
		if (psDistToRoot->iExpectedDist < iMinDist)
		{
			iMinDist = psDistToRoot->iExpectedDist;
			pcMinDistToRoot = psDistToRoot;
		}
	}

	return pcMinDistToRoot;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
CBaseObject* CDistCalculatorParameters::GetUnattached(void)
{
	if (mapcUnattched.IsEmpty())
	{
		return NULL;
	}

	return *mapcUnattched.Tail();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
CBaseObject* CDistCalculatorParameters::GetUnattached(int iIndex)
{
	return *mapcUnattched.Get(iIndex);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
int CDistCalculatorParameters::NumExpectedDists(void)
{
	return macExpectedDists.NumElements();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
int CDistCalculatorParameters::NumUnattached(void)
{
	return mapcUnattched.NumElements();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
SDistToRoot* CDistCalculatorParameters::GetExpectedDist(int iIndex)
{
	return macExpectedDists.SafeGet(iIndex);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CDistCalculatorParameters::RemoveExpectedDist(int iIndex)
{
	macExpectedDists.RemoveAt(iIndex);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CDistCalculatorParameters::RemoveExpectedDist(SDistToRoot* psDistToRoot)
{
	int				i;
	SDistToRoot*	psCurrent;

	for (i = 0; i < macExpectedDists.NumElements(); i++)
	{
		psCurrent = macExpectedDists.Get(i);
		if (psCurrent == psDistToRoot)
		{
			macExpectedDists.RemoveAt(i, FALSE);
			break;
		}
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CDistCalculatorParameters::RemoveUnattached(CBaseObject* pcBaseObject)
{
	int				i;
	CBaseObject*	pcCurrent;

	for (i = mapcUnattched.NumElements()-1; i >= 0; i--)
	{
		pcCurrent = *mapcUnattched.Get(i);
		if (pcCurrent == pcBaseObject)
		{
			mapcUnattched.RemoveAt(i, FALSE);
			break;
		}
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CDistCalculatorParameters::MarkExpectedDistLowestFroms(void)
{
	int				i;
	SDistToRoot*	psCurrent;

	for (i = 0; i < macExpectedDists.NumElements(); i++)
	{
		psCurrent = macExpectedDists.Get(i);
		mapcLowestFroms.Add(&psCurrent->pcObject);
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CDistCalculatorParameters::MarkUnattachedLowestFroms(void)
{
	int				i;
	CBaseObject*	pcCurrent;

	for (i = 0; i < mapcUnattched.NumElements(); i++)
	{
		pcCurrent = *mapcUnattched.Get(i);
		mapcLowestFroms.Add(&pcCurrent);
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
CArrayBaseObjectPtr* CDistCalculatorParameters::GetLowestFroms(void)
{
	return &mapcLowestFroms;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CDistCalculatorParameters::AddChangedFromAsLowest(CBaseObject* pcFromChanged)
{
	int				i;
	CBaseObject*	pcObject;
	int				iNumElements;

	iNumElements = mapcLowestFroms.NumElements();
	for (i = 0; i < iNumElements; i++)
	{
		pcObject = *mapcLowestFroms.Get(i);
		if (pcObject == pcFromChanged)
		{
			return;
		}
	}

	mapcLowestFroms.Add(&pcFromChanged);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CDistCalculatorParameters::AddDetachedFromRoot(CBaseObject* pcObject)
{
	mapcDetachedFromRoot.Add(&pcObject);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
int CDistCalculatorParameters::NumDetachedFromRoot(void)
{
	return mapcDetachedFromRoot.NumElements();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
CBaseObject* CDistCalculatorParameters::GetDetachedFromRoot(int iIndex)
{
	return *mapcDetachedFromRoot.Get(iIndex);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CDistCalculatorParameters::AddCompletelyDetached(CBaseObject* pcObject)
{
	mapcCompletelyDetached.Add(&pcObject);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
int CDistCalculatorParameters::NumCompletelyDetached(void)
{
	return mapcCompletelyDetached.NumElements();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
CBaseObject* CDistCalculatorParameters::GetCompletelyDetached(int iIndex)
{
	return *mapcCompletelyDetached.Get(iIndex);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CDistCalculatorParameters::RemoveCompletelyDetached(int iIndex)
{
	mapcCompletelyDetached.RemoveAt(iIndex, FALSE);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CDistCalculatorParameters::CopyRootDetachedToCompletelyDetached(void)
{
	mapcCompletelyDetached.Copy(&mapcDetachedFromRoot);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
CArrayBaseObjectPtr* CDistCalculatorParameters::GetCompletelyDetachedArray(void)
{
	return &mapcCompletelyDetached;
}

