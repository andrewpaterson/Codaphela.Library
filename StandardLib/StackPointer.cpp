#include "Pointer.h"
#include "Collection.h"
#include "StackPointer.h"


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CStackPointer::Init(void)
{
	msPointer.meType = SPT_Unknown;
	msPointer.u.pcPointer = NULL;
	mpcNext = NULL;
	mbUsed = true;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CStackPointer::Init(CPointer* pcPointer)
{
	msPointer.meType = SPT_Pointer;
	msPointer.u.pcPointer = pcPointer;
	mpcNext = NULL;
	mbUsed = true;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CStackPointer::Init(CCollection* pcCollection)
{
	msPointer.meType = SPT_Pointer;
	msPointer.u.pcCollection = pcCollection;
	mpcNext = NULL;
	mbUsed = true;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CStackPointer::Kill(void)
{
	msPointer.meType = SPT_Unknown;
	msPointer.u.pcPointer = NULL;
	mpcNext = NULL;
	mbUsed = false;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CStackPointer::IsUsed(void)
{
	return mbUsed;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CStackPointer::SetNext(CStackPointer* pcNext)
{
	mpcNext = pcNext;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
int CStackPointer::NumPointers(void)
{
	CStackPointer* pcNext;

	int iCount;

	iCount = 1;
	pcNext = mpcNext;
	while (pcNext != NULL)
	{
		iCount++;
		pcNext = pcNext->mpcNext;
	}
	
	return iCount;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
CStackPointer* CStackPointer::FindLast(void)
{
	CStackPointer* pcNext;

	pcNext = this;
	while (pcNext->mpcNext != NULL)
	{
		pcNext = pcNext->mpcNext;
	}

	return pcNext;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
CStackPointer* CStackPointer::GetNext(void)
{
	return mpcNext;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
CStackPointer* CStackPointer::Remove(CPointer* pcPointer)
{
	CStackPointer* pcNext;
	CStackPointer* pcPrev;
	CStackPointer* pcThis;

	pcNext = this;
	pcPrev = NULL;
	while (pcNext != NULL)
	{
		pcThis = pcNext;
		if (pcThis->msPointer.u.pcPointer == pcPointer)
		{
			if (pcPrev)
			{
				pcPrev->SetNext(pcThis->mpcNext);
				pcThis->Kill();
				return this;
			}
			else
			{
				pcNext = mpcNext;
				Kill();
				return pcNext;
			}
		}
		pcPrev = pcNext;
		pcNext = pcNext->mpcNext;
	}

	return this;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CStackPointer::RemoveAll(void)
{
	CStackPointer* pcNext;
	CStackPointer* pcThis;

	pcNext = this;
	while (pcNext != NULL)
	{
		pcThis = pcNext;
		pcNext = pcNext->mpcNext;
		pcThis->Kill();
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CStackPointer::ClearPointer(void)
{
	if (msPointer.meType == SPT_Pointer)
	{
		msPointer.u.pcPointer->UnsafeClearObject();
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
CStackPointer* CStackPointer::ClearPointerGetNext(void)
{
	ClearPointer();
	return GetNext();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
EStackPointerType CStackPointer::GetType(void)
{
	return msPointer.meType;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
SStackPointer* CStackPointer::Get(void)
{
	return &msPointer;
}

