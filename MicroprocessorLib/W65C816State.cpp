#include "BaseLib/Logger.h"
#include "InstructionFactory.h"
#include "W65C816State.h"


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::Init(void)
{
    mcProgramCounter.Init();
    muiStackPointer = 0x01FF;
    muiAccumulator = 0;
    muiXIndex = 0;
    muiYIndex = 0;
    muiDataBank = 0;
    muiDirectPage = 0;

    mbZeroFlag = false;
    mbNegativeFlag = false;
    mbDecimalFlag = false;
    mbInterruptDisableFlag = false;
    mbAccumulatorWidthFlag = false;
    mbIndexWidthFlag = false;
    mbCarryFlag = false;
    mbEmulationFlag = true;
    mbOverflowFlag = false;
    mbBreakFlag = false;

    mbStopped = false;
    mbBusEnable = true;
    mbNextInstruction = false;

    muiData = 0;
    miCycle = 0;
    muiOpCodeIndex = GetResetOpcode()->GetCode();
    muiInternal16BitData = 0;
    muiDirectOffset = 0;
    mcNewProgramCounter.Init();
    mcAddress.Init();
    mbNmi = false;

    CreateAbortValues();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::Init(CW65C816State state)
{
    mbZeroFlag = state.mbZeroFlag;
    mbNegativeFlag = state.mbNegativeFlag;
    mbDecimalFlag = state.mbDecimalFlag;
    mbInterruptDisableFlag = state.mbInterruptDisableFlag;
    mbAccumulatorWidthFlag = state.mbAccumulatorWidthFlag;
    mbIndexWidthFlag = state.mbIndexWidthFlag;
    mbCarryFlag = state.mbCarryFlag;
    mbEmulationFlag = state.mbEmulationFlag;
    mbOverflowFlag = state.mbOverflowFlag;
    mbBreakFlag = state.mbBreakFlag;
    muiAccumulator = state.mbAccumulatorWidthFlag;
    muiXIndex = state.muiXIndex;
    muiYIndex = state.muiYIndex;
    muiDataBank = state.muiDataBank;
    muiDirectPage = state.muiDirectPage;
    mcProgramCounter.Init(&state.mcProgramCounter);
    muiStackPointer = state.muiStackPointer;
    miCycle = state.miCycle;
    muiOpCodeIndex = state.muiOpCodeIndex;
    mbStopped = state.mbStopped;
    muiAbortProcessRegister = state.muiAbortProcessRegister;
    muiAbortAccumulator = state.muiAbortAccumulator;
    muiAbortXIndex = state.muiAbortXIndex;
    muiAbortYIndex = state.muiAbortYIndex;
    muiAbortDataBank = state.muiAbortDataBank;
    muiAbortDirectPage = state.muiAbortDirectPage;
    mcAbortProgramCounter.Init(&state.mcAbortProgramCounter);
    muiAbortStackPointer = state.muiAbortStackPointer;
    mcAddress.Init(&state.mcAddress);
    muiInternal16BitData = state.muiInternal16BitData;
    muiDirectOffset = state.muiDirectOffset;
    mcNewProgramCounter.Init(&state.mcNewProgramCounter);
    mbBusEnable = state.mbBusEnable;
    mbIrq = state.mbIrq;
    mbAbort = state.mbAbort;
    mbNextInstruction = state.mbNextInstruction;
    muiData = state.muiData;
    mbNmi = state.mbNmi;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
CInstruction* CW65C816State::GetInstruction(uint16 uiOpcode)
{
	return CInstructionFactory::GetInstance()->GetInstruction(uiOpcode);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
CInstruction* CW65C816State::GetResetOpcode(void)
{
	return CInstructionFactory::GetInstance()->GetReset();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
CInstruction* CW65C816State::GetIrqOpcode(void)
{
	return CInstructionFactory::GetInstance()->GetIRQ();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
CInstruction* CW65C816State::GetNmiOpcode(void)
{
	return CInstructionFactory::GetInstance()->GetNMI();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
CInstruction* CW65C816State::GetAbortOpcode(void)
{
	return CInstructionFactory::GetInstance()->GetAbort();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
CInstruction* CW65C816State::GetFetchNextOpcode(void)
{
	return CInstructionFactory::GetInstance()->GetFetchNext();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::CreateAbortValues(void)
{
    muiAbortProcessRegister = GetProcessorRegisterValue();
    muiAbortAccumulator = muiAccumulator;
    muiAbortXIndex = muiXIndex;
    muiAbortYIndex = muiYIndex;
    muiAbortDataBank = muiDataBank;
    muiAbortDirectPage = muiDirectPage;
    mcAbortProgramCounter.Init(&mcProgramCounter);
    muiAbortStackPointer = muiStackPointer;
}

//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::CreatePartialAbortValues(void)
{
    muiAbortProcessRegister = GetProcessorRegisterValue();
    muiAbortDataBank = muiDataBank;
    mcAbortProgramCounter.Init(mcProgramCounter.GetBank(), mcAbortProgramCounter.GetOffset());
}

//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::RestoreAbortValues(void)
{
    muiAbortProcessRegister = GetProcessorRegisterValue();
    muiAccumulator = muiAbortAccumulator;
    muiXIndex = muiAbortXIndex;
    muiYIndex = muiAbortYIndex;
    muiDataBank = muiAbortDataBank;
    muiDirectPage = muiAbortDirectPage;
    mcProgramCounter.Init(&mcAbortProgramCounter);
    muiStackPointer = muiAbortStackPointer;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::ResetPulled(void)
{
    mbAbort = false;
    mbNmi = false;
    muiOpCodeIndex = GetResetOpcode()->GetCode();
    mbStopped = false;
    miCycle = 0;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
uint8 CW65C816State::GetProcessorRegisterValue(void)
{
    int value = 0;
    if (IsCarrySet())
    {
        value |= STATUS_CARRY;
    }
    if (IsZeroFlagSet())
    {
        value |= STATUS_ZERO;
    }
    if (IsInterruptDisable())
    {
        value |= STATUS_INTERRUPT_DISABLE;
    }
    if (IsDecimal())
    {
        value |= STATUS_DECIMAL;
    }
    if (mbEmulationFlag && mbBreakFlag)
    {
        value |= STATUS_BREAK;
    }
    if (!mbEmulationFlag && mbIndexWidthFlag)
    {
        value |= STATUS_INDEX_WIDTH;
    }
    if (!mbEmulationFlag && mbAccumulatorWidthFlag)
    {
        value |= STATUS_ACCUMULATOR_WIDTH;
    }
    if (IsOverflowFlag())
    {
        value |= STATUS_OVERFLOW;
    }
    if (IsNegativeSet())
    {
        value |= STATUS_NEGATIVE;
    }

    return value;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::ResetPulled(void)
{
    mbAbort = false;
    mbNmi = false;
    muiOpCodeIndex = GetResetOpcode()->GetCode();
    mbStopped = false;
    miCycle = 0;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::ResetPulled(void)
{
    mbAbort = false;
    mbNmi = false;
    muiOpCodeIndex = GetResetOpcode()->GetCode();
    mbStopped = false;
    miCycle = 0;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetZeroFlag(bool bZeroFlag)
{
    mbZeroFlag = bZeroFlag;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetNegativeFlag(bool bSignFlag)
{
    mbNegativeFlag = bSignFlag;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetDecimalFlag(bool bDecimalFlag)
{
    mbDecimalFlag = bDecimalFlag;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetInterruptDisableFlag(bool bInterruptDisableFlag)
{
    mbInterruptDisableFlag = bInterruptDisableFlag;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetAccumulatorWidthFlag(bool bAccumulatorWidthFlag)
{
    mbAccumulatorWidthFlag = bAccumulatorWidthFlag;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetIndexWidthFlag(bool bIndexWidthFlag)
{
    mbIndexWidthFlag = bIndexWidthFlag;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetCarryFlag(bool bCarryFlag)
{
    mbCarryFlag = bCarryFlag;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetEmulationFlag(bool bEmulationFlag)
{
    mbEmulationFlag = bEmulationFlag;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CW65C816State::IsZeroFlagSet(void)
{
    return mbZeroFlag;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CW65C816State::IsNegativeSet(void)
{
    return mbNegativeFlag;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CW65C816State::IsDecimal(void)
{
    return mbDecimalFlag;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CW65C816State::IsInterruptDisable(void)
{
    return mbInterruptDisableFlag;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CW65C816State::IsCarrySet(void)
{
    return mbCarryFlag;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CW65C816State::IsEmulation(void)
{
    return mbEmulationFlag;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CW65C816State::IsBreak(void)
{
    return mbBreakFlag;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CW65C816State::IsOverflowFlag(void)
{
    return mbOverflowFlag;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetBreakFlag(bool bBreakFlag)
{
    mbBreakFlag = bBreakFlag;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetOverflowFlag(bool bOverflowFlag)
{
    mbOverflowFlag = bOverflowFlag;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::Cycle(CW65C816* pcCPU)
{
    if (mbNextInstruction)
    {
        miCycle = -1;
        mbNextInstruction = false;
        NextInstruction();
    }

    NextCycle();
    while (!GetBusCycle()->MustExecute(pcCPU))
    {
        NextCycle();
    }
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::ExecuteOperation(CW65C816* pcCPU)
{
	CBusCycle* pcBusCycle;
	COperationArray* pcOperations;
	size				 uiNumElements;
	size				 i;
	COperation* pcOperation;

	pcBusCycle = GetBusCycle();
	pcOperations = pcBusCycle->GetOperations();
	uiNumElements = pcOperations->NumElements();
	for (i = 0; i < uiNumElements; i++)
	{
		pcOperation = pcOperations->GetPtr(i);
		pcOperation->Execute(pcCPU);
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
CBusCycle* CW65C816State::GetBusCycle(void)
{
	CInstruction* pcInstruction;
	CInstructionCycles* pcCycles;

	pcInstruction = CInstructionFactory::GetInstance()->GetInstruction(muiOpCodeIndex);

	pcCycles = pcInstruction->GetCycles();
	return pcCycles->GetBusCycle(miCycle);
}

//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::NextInstruction(void)
{
	if (!mbAbort)
	{
		CreateAbortValues();
	}

	if (mbNmi)
	{
		muiOpCodeIndex = GetNmiOpcode()->GetCode();
		mbNmi = false;
	}
	else if (abort)
	{
		muiOpCodeIndex = GetAbortOpcode()->GetCode();
		mbAbort = false;
	}
	else if (mbIrq && !mbInterruptDisableFlag)
	{
		muiOpCodeIndex = GetIrqOpcode()->GetCode();
	}
	else
	{
		muiOpCodeIndex = GetFetchNextOpcode()->GetCode();
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::DoneInstruction(void)
{
	mbNextInstruction = true;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::NextCycle(void)
{
	miCycle++;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
int16 CW65C816State::GetCycle(void)
{
	return miCycle;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetOpCode(uint16 uiOpCodeIndex)
{
	if ((uiOpCodeIndex >= 0) && (uiOpCodeIndex <= 255))
	{
		muiOpCodeIndex = uiOpCodeIndex;
	}
	else
	{
		LOG_ERROR("Invalid Op-code.");
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
CDataOperation* CW65C816State::GetDataOperation(void)
{
	CBusCycle* pcBusCycle = GetBusCycle();
	if (pcBusCycle != NULL)
	{
		return pcBusCycle->GetDataOperation();
	}
	else
	{
		CInstruction* pcInstruction = CInstructionFactory::GetInstance()->GetInstruction(muiOpCodeIndex);
		//System.out.println("W65C816.GetDataOperation: CBusCycle for OpCode [" + instruction.getName() + "] Cycle [" + cycle + "] cannot be fetch.  OpCode cycles size [" + instruction.getCycles().size() + "].");
		return NULL;
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CW65C816State::IsStopped(void)
{
	return mbStopped;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CW65C816State::IsRead(void)
{
	return GetDataOperation()->IsRead();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CW65C816State::IsMemory8Bit(void)
{
	if (IsEmulation())
	{
		return true;
	}
	else
	{
		return mbAccumulatorWidthFlag;
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CW65C816State::IsMemory16Bit(void)
{
	return !IsMemory8Bit();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CW65C816State::IsIndex8Bit()
{
	if (IsEmulation())
	{
		return true;
	}
	else
	{
		return mbIndexWidthFlag;
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetX(uint16 uiXIndex)
{
	if (IsIndex16Bit())
	{
		Assert16Bit(uiXIndex, "X Index register");
		muiXIndex = uiXIndex;
	}
	else
	{
		Assert8Bit(uiXIndex, "X Index register");
		muiXIndex = SetLowByte(muiXIndex, uiXIndex);
	}
	SetSignAndZeroFromIndex(muiXIndex);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetY(uint16 uiYIndex)
{
	if (IsIndex16Bit())
	{
		Assert16Bit(uiYIndex, "Y Index register");
		muiYIndex = uiYIndex;
	}
	else
	{
		Assert8Bit(uiYIndex, "Y Index register");
		muiYIndex = SetLowByte(muiYIndex, uiYIndex);
	}
	SetSignAndZeroFromIndex(muiYIndex);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetA(uint16 uiAccumulator)
{
	if (IsMemory16Bit())
	{
		Assert16Bit(uiAccumulator, "Accumulator");
		muiAccumulator = uiAccumulator;
	}
	else
	{
		Assert8Bit(uiAccumulator, "Accumulator");
		muiAccumulator = SetLowByte(muiAccumulator, uiAccumulator);
	}

	SetSignAndZeroFromMemory(muiAccumulator);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetC(uint16 uiAccumulator)
{
	Assert16Bit(uiAccumulator, "Accumulator");
	muiAccumulator = uiAccumulator;
	SetSignAndZeroFlagFrom16BitValue(uiAccumulator);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetData(uint16 uiData, bool bUpdateFlags)
{
	if (IsMemory16Bit())
	{
		Assert16Bit(uiData, "Data");
		muiInternal16BitData = uiData;
	}
	else
	{
		Assert8Bit(uiData, "Data");
		muiInternal16BitData = SetLowByte(muiInternal16BitData, uiData);
	}
	if (bUpdateFlags)
	{
		SetSignAndZeroFromMemory(uiData);
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetIndexData(uint16 uiData, bool bUpdateFlags)
{
	if (IsIndex16Bit())
	{
		Assert16Bit(uiData, "Data");
		muiInternal16BitData = uiData;
	}
	else
	{
		Assert8Bit(uiData, "Data");
		muiInternal16BitData = SetLowByte(muiInternal16BitData, uiData);
	}
	if (bUpdateFlags)
	{
		SetSignAndZeroFromIndex(uiData);
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetSignAndZeroFromMemory(uint16 uiValue)
{
	if (IsMemory16Bit())
	{
		SetSignAndZeroFlagFrom16BitValue(uiValue);
	}
	else
	{
		SetSignAndZeroFlagFrom8BitValue(uiValue);
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetSignAndZeroFromIndex(uint16 uiValue)
{
	if (IsIndex16Bit())
	{
		SetSignAndZeroFlagFrom16BitValue(uiValue);
	}
	else
	{
		SetSignAndZeroFlagFrom8BitValue(uiValue);
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetInternal16BitData(uint16 uiInternal16BitData)
{
	SetData(uiInternal16BitData, true);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
uint16 CW65C816State::GetA(void)
{
	if (IsMemory16Bit())
	{
		return muiAccumulator;
	}
	else
	{
		return ToByte(muiAccumulator);
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
uint16 CW65C816State::GetC(void)
{
	return muiAccumulator;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
uint16 CW65C816State::GetX(void)
{
	if (IsIndex16Bit())
	{
		return muiXIndex;
	}
	else
	{
		return ToByte(muiXIndex);
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
uint16 CW65C816State::GetY(void)
{
	if (IsIndex16Bit())
	{
		return muiYIndex;
	}
	else
	{
		return ToByte(muiYIndex);
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
uint8 CW65C816State::GetDataBank(void)
{
	return muiDataBank;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetDataBank(uint8 uiDataBank)
{
	Assert8Bit(uiDataBank, "Data Bank");
	muiDataBank = uiDataBank;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetDirectPage(uint16 uiDirectPage)
{
	muiDirectPage = uiDirectPage;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
CAddress* CW65C816State::GetProgramCounter(void)
{
	return &mcProgramCounter;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetProcessorRegisterValue(uint8 uiValue)
{
	SetCarryFlag((uiValue & STATUS_CARRY) != 0);
	SetZeroFlag((uiValue & STATUS_ZERO) != 0);
	SetInterruptDisableFlag((uiValue & STATUS_INTERRUPT_DISABLE) != 0);
	SetDecimalFlag((uiValue & STATUS_DECIMAL) != 0);

	if (IsEmulation())
	{
		SetBreakFlag((uiValue & STATUS_BREAK) != 0);
	}
	else
	{
		SetIndexWidthFlag((uiValue & STATUS_INDEX_WIDTH) != 0);
	}

	SetAccumulatorWidthFlag(!IsEmulation() && ((uiValue & STATUS_ACCUMULATOR_WIDTH) != 0));
	SetOverflowFlag((uiValue & STATUS_OVERFLOW) != 0);

	SetNegativeFlag((uiValue & STATUS_NEGATIVE) != 0);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetZeroFlagFrom8BitValue(uint16 uiValue)
{
	SetZeroFlag(Is8bitValueZero(uiValue));
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetZeroFlagFrom16BitValue(uint16 uiValue)
{
	SetZeroFlag(Is16bitValueZero(uiValue));
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetNegativeFlagFrom8BitValue(uint16 uiValue)
{
	SetNegativeFlag(Is8bitValueNegative(uiValue));
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetNegativeFlagFrom16BitValue(uint16 uiValue)
{
	SetNegativeFlag(Is16bitValueNegative(uiValue));
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetSignAndZeroFlagFrom8BitValue(uint16 uiValue)
{
	SetNegativeFlagFrom8BitValue(uiValue);
	SetZeroFlagFrom8BitValue(uiValue);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetSignAndZeroFlagFrom16BitValue(uint16 uiValue)
{
	SetNegativeFlagFrom16BitValue(uiValue);
	SetZeroFlagFrom16BitValue(uiValue);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CW65C816State::Is8bitValueNegative(uint16 uiValue)
{
	return (uiValue & 0x80) != 0;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CW65C816State::Is16bitValueNegative(uint16 uiValue)
{
	return (uiValue & 0x8000) != 0;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CW65C816State::Is8bitValueZero(uint16 uiValue)
{
	return (ToByte(uiValue) == 0);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CW65C816State::Is16bitValueZero(uint16 uiValue)
{
	return uiValue == 0;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CW65C816State::IsMemoryNegative(uint16 uiOperand)
{
	if (IsMemory16Bit())
	{
		return Is16bitValueNegative(uiOperand);
	}
	else
	{
		return Is8bitValueNegative(uiOperand);
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::BlockMoveNext(void)
{
	if (muiAccumulator != 0xffff)
	{
		muiAccumulator--;
		muiXIndex = TrimIndex(++muiXIndex);
		muiYIndex = TrimIndex(++muiYIndex);
		mcProgramCounter.Offset(-3);
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::BlockMovePrevious(void)
{
	if (muiAccumulator != 0xffff)
	{
		muiAccumulator--;
		muiXIndex = TrimIndex(--muiXIndex);
		muiYIndex = TrimIndex(--muiYIndex);
		mcProgramCounter.Offset(-3);
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
uint16 CW65C816State::TrimMemory(uint16 uiValue)
{
	if (IsMemory8Bit())
	{
		uiValue = ToByte(uiValue);
	}
	return uiValue;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
uint16 CW65C816State::TrimIndex(uint16 uiValue)
{
	if (IsIndex8Bit())
	{
		uiValue = ToByte(uiValue);
	}
	return uiValue;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CW65C816State::IsIndex16Bit(void)
{
	return !IsIndex8Bit();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
uint16 CW65C816State::GetCarry(void)
{
	return IsCarrySet() ? 1 : 0;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CW65C816State::IsSignSet(void)
{
	return IsNegativeSet();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CW65C816State::IsOverflowSet(void)
{
	return IsOverflowFlag();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetProgramCounter(CAddress* pcAddress)
{
	mcProgramCounter.Init(pcAddress);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetProgramAddressBank(uint8 uibank)
{
	mcProgramCounter.SetBank(uibank);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetAddressLow(uint8 uiAddressLow)
{
	mcAddress.SetOffsetLow(uiAddressLow);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetAddressHigh(uint8 uiAddressHigh)
{
	mcAddress.SetOffsetLow(uiAddressHigh);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetAddressBank(uint8 uiAddressBank)
{
	mcAddress.SetBank(uiAddressBank);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
uint8 CW65C816State::GetDataLow(void)
{
	return GetLowByte(muiInternal16BitData);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
uint8 CW65C816State::GetDataHigh(void)
{
	return GetHighByte(muiInternal16BitData);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
uint16 CW65C816State::GetInternal16BitData(void)
{
	if (IsMemory16Bit())
	{
		return muiInternal16BitData;
	}
	else
	{
		return ToByte(muiInternal16BitData);
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
uint16 CW65C816State::GetIndexData(void)
{
	if (IsIndex16Bit())
	{
		return muiInternal16BitData;
	}
	else
	{
		return ToByte(muiInternal16BitData);
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
uint16 CW65C816State::GetData16Bit(void)
{
	return muiInternal16BitData;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
uint16 CW65C816State::GetDirectPage(void)
{
	return muiDirectPage;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
uint16 CW65C816State::GetDirectOffset(void)
{
	return muiDirectOffset;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
uint16 CW65C816State::GetStackPointer(void)
{
	if (!IsEmulation())
	{
		return muiStackPointer;
	}
	else
	{
		return GetLowByte(muiStackPointer) | 0x100;
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
CAddress* CW65C816State::GetAddress(void)
{
	return &mcAddress;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
CInstruction* CW65C816State::GetOpCode(void)
{
	CInstructionFactory::GetInstance()->GetInstruction(muiOpCodeIndex);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
CAddress* CW65C816State::GetNewProgramCounter(void)
{
	return &mcNewProgramCounter;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::IncrementProgramAddress(void)
{
	mcProgramCounter.Offset(1);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::DecrementProgramCounter(void)
{
	mcProgramCounter.Offset(-1);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::IncrementStackPointer(void)
{
	muiStackPointer++;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::DecrementStackPointer(void)
{
	muiStackPointer--;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetDirectOffset(uint8 uiData)
{
	muiDirectOffset = uiData;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetDataLow(uint8 uiData)
{
	muiInternal16BitData = SetLowByte(muiInternal16BitData, uiData);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetDataHigh(uint8 uiData)
{
	muiInternal16BitData = SetHighByte(muiInternal16BitData, uiData);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetStackPointer(uint16 uiData)
{
	muiStackPointer = uiData;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetNewProgramCounterLow(uint8 uiData)
{
	mcNewProgramCounter.SetOffsetLow(uiData);

}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetNewProgramCounterHigh(uint8 uiData)
{
	mcNewProgramCounter.SetOffsetHigh(uiData);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetNewProgramCounterBank(uint8 uiData)
{
	mcNewProgramCounter.SetBank(uiData);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetEmulationMode(bool bEmulation)
{
	SetEmulationFlag(bEmulation);
	if (bEmulation)
	{
		muiXIndex = ToByte(muiXIndex);
		muiYIndex = ToByte(muiYIndex);
		SetAccumulatorWidthFlag(true);
		SetIndexWidthFlag(true);
		muiStackPointer = ToByte(muiStackPointer) | 0x100;
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::ProcessorStatusChanged(void)
{
	if (mbIndexWidthFlag)
	{
		muiXIndex = ToByte(muiXIndex);
		muiYIndex = ToByte(muiYIndex);
	}
	if (IsEmulation())
	{
		SetIndexWidthFlag(true);
		SetAccumulatorWidthFlag(true);
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::Execute8BitADC(void)
{
	uint16	uiOperand;
	uint16	uiAccumulator;
	uint16	bCarryValue;
	uint16	uiResult;
	bool	bCarryOutOfPenultimateBit;
	bool	bCarry;

	uiOperand = GetInternal16BitData();
	uiAccumulator = GetA();
	bCarryValue = GetCarry();

	uiResult = uiAccumulator + uiOperand + bCarryValue;

	uiAccumulator &= 0x7F;
	uiOperand &= 0x7F;
	bCarryOutOfPenultimateBit = IsMemoryNegative(TrimMemory(uiAccumulator + uiOperand + bCarryValue));

	bCarry = (uiResult & 0x0100) != 0;
	SetCarryFlag(bCarry);
	SetOverflowFlag(bCarry ^ bCarryOutOfPenultimateBit);
	SetA(TrimMemory(uiResult));
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::Execute16BitADC(void)
{
	uint16	uiOperand;
	uint16	uiAccumulator;
	uint16	bCarryValue;
	uint16	uiResult;
	bool	bCarryOutOfPenultimateBit;
	bool	bCarry;

	uiOperand = GetInternal16BitData();
	uiAccumulator = GetA();
	bCarryValue = GetCarry();

	uiResult = uiAccumulator + uiOperand + bCarryValue;

	uiAccumulator &= 0x7FFF;
	uiOperand &= 0x7FFF;
	bCarryOutOfPenultimateBit = IsMemoryNegative(TrimMemory(uiAccumulator + uiOperand + bCarryValue));

	bCarry = (uiResult & 0x010000) != 0;
	SetCarryFlag(bCarry);
	SetOverflowFlag(bCarry ^ bCarryOutOfPenultimateBit);
	SetA(TrimMemory(uiResult));
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::Execute8BitBCDADC(void)
{
	uint16		uiOperand;
	uint16		uiAccumulator;
	CBCDResult	cBCDResult;

	uiOperand = GetDataLow();
	uiAccumulator = GetA();

	cBCDResult = BCDAdd8Bit(uiOperand, uiAccumulator, IsCarrySet());
	SetCarryFlag(cBCDResult.mbCarry);
	SetA(cBCDResult.muiValue);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::Execute16BitBCDADC(void)
{
	uint16		uiOperand;
	uint16		uiAccumulator;
	CBCDResult	cBCDResult;

	uiOperand = GetInternal16BitData();
	uiAccumulator = GetA();

	cBCDResult = BCDAdd16Bit(uiOperand, uiAccumulator, IsCarrySet());
	SetCarryFlag(cBCDResult.mbCarry);
	SetA(cBCDResult.muiValue);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::Execute8BitSBC(void)
{
	uint16	uiOperand;
	uint16	uiAccumulator;
	uint16	uiBorrowValue;
	uint16	uiResult;
	bool	bBorrowFromPenultimateBit;
	bool	bBorrow;

	uiOperand = GetInternal16BitData();
	uiAccumulator = GetA();
	uiBorrowValue = 1 - GetCarry();

	uiResult = uiAccumulator - uiOperand - uiBorrowValue;

	uiAccumulator &= 0x7F;
	uiOperand &= 0x7F;
	bBorrowFromPenultimateBit = IsMemoryNegative(TrimMemory(uiAccumulator - uiOperand - uiBorrowValue));
	bBorrow = (uiResult & 0x0100) != 0;

	SetCarryFlag(!bBorrow);
	SetOverflowFlag(bBorrow ^ bBorrowFromPenultimateBit);
	SetA(TrimMemory(uiResult));
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::Execute16BitSBC(void)
{
	uint16	uiOperand;
	uint16	uiAccumulator;
	uint16	uiBorrowValue;
	uint16	uiResult;
	bool	bBorrowFromPenultimateBit;
	bool	bBorrow;

	uiOperand = GetInternal16BitData();
	uiAccumulator = GetA();
	uiBorrowValue = 1 - GetCarry();

	uiResult = uiAccumulator - uiOperand - uiBorrowValue;

	uiAccumulator &= 0x7FFF;
	uiOperand &= 0x7FFF;
	bBorrowFromPenultimateBit = IsMemoryNegative(TrimMemory(uiAccumulator - uiOperand - uiBorrowValue));
	bBorrow = (uiResult & 0x010000) != 0;

	SetCarryFlag(!bBorrow);
	SetOverflowFlag(bBorrow ^ bBorrowFromPenultimateBit);
	SetA(TrimMemory(uiResult));
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::Execute8BitBCDSBC(void)
{
	uint16		uiOperand;
	uint16		uiAccumulator;
	CBCDResult	cBCDResult;

	uiOperand = GetDataLow();
	uiAccumulator = GetLowByte(GetA());

	cBCDResult = BCDSubtract8Bit(uiOperand, uiAccumulator, !IsCarrySet());
	SetCarryFlag(!cBCDResult.mbCarry);
	SetA(cBCDResult.muiValue);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::Execute16BitBCDSBC(void)
{
	uint16		uiOperand;
	uint16		uiAccumulator;
	CBCDResult	cBCDResult;

	uiOperand = GetInternal16BitData();
	uiAccumulator = GetA();

	cBCDResult = BCDSubtract16Bit(uiOperand, uiAccumulator, !IsCarrySet());
	SetCarryFlag(!cBCDResult.mbCarry);
	SetA(cBCDResult.muiValue);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
CBCDResult CW65C816State::BCDAdd8Bit(uint16 uiBCDFirst, uint16 uiBCDSecond, bool bCarry)
{
	uint16		uiShift;
	uint16		uiResult;
	uint16		uiDigitOfFirst;
	uint16		uiDigitOfSecond;
	uint16		uiSumOfDigits;
	CBCDResult	cResult;

	uiShift = 0;
	uiResult = 0;

	while (uiShift < 8)
	{
		uiDigitOfFirst = (uiBCDFirst & 0xF);
		uiDigitOfSecond = (uiBCDSecond & 0xF);
		uiSumOfDigits = ToByte(uiDigitOfFirst + uiDigitOfSecond + (bCarry ? 1 : 0));
		bCarry = uiSumOfDigits > 9;
		if (bCarry)
		{
			uiSumOfDigits += 6;
		}
		uiSumOfDigits &= 0xF;
		uiResult |= uiSumOfDigits << uiShift;

		uiShift += 4;
		uiBCDFirst >>= uiShift;
		uiBCDSecond >>= uiShift;
	}

	cResult.Init(uiResult, bCarry);
	return cResult;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
CBCDResult CW65C816State::BCDAdd16Bit(uint16 uiBCDFirst, uint16 uiBCDSecond, bool bCarry)
{
	uint16		uiShift;
	uint16		uiResult;
	uint16		uiDigitOfFirst;
	uint16		uiDigitOfSecond;
	uint16		uiSumOfDigits;
	CBCDResult	cResult;
	CBCDResult	cBCD8BitResult;

	uiResult = 0;
	uiShift = 0;
	while (uiShift < 16)
	{
		uiDigitOfFirst = uiBCDFirst & 0xFF;
		uiDigitOfSecond = uiBCDSecond & 0xFF;
		cBCD8BitResult = BCDAdd8Bit(uiDigitOfFirst, uiDigitOfSecond, bCarry);
		bCarry = cBCD8BitResult.mbCarry;
		uiResult = uiResult | (cBCD8BitResult.muiValue << uiShift);
		uiShift += 8;
		uiBCDFirst = uiBCDFirst >> uiShift;
		uiBCDSecond = uiBCDSecond >> uiShift;
	}

	cResult.Init(uiResult, bCarry);
	return cResult;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
CBCDResult CW65C816State::BCDSubtract8Bit(uint16 uiBCDFirst, uint16 uiBCDSecond, bool bBorrow)
{
	uint16		uiShift;
	uint16		uiResult;
	uint16		uiDigitOfFirst;
	uint16		uiDigitOfSecond;
	uint16		uiDiffOfDigits;
	CBCDResult	cResult;

	while (uiShift < 8)
	{
		uiDigitOfFirst = uiBCDFirst & 0xF;
		uiDigitOfSecond = uiBCDSecond & 0xF;
		uiDiffOfDigits = ToByte(uiDigitOfFirst - uiDigitOfSecond - (bBorrow ? 1 : 0));
		bBorrow = uiDiffOfDigits > 9;
		if (bBorrow)
		{
			uiDiffOfDigits -= 6;
		}
		uiDiffOfDigits &= 0xF;
		uiResult |= uiDiffOfDigits << uiShift;

		uiShift += 4;
		uiBCDFirst >>= uiShift;
		uiBCDSecond >>= uiShift;
	}

	cResult.Init(uiResult, bBorrow);
	return cResult;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
CBCDResult CW65C816State::BCDSubtract16Bit(uint16 uiBCDFirst, uint16 uiBCDSecond, bool bBorrow)
{
	uint16		uiShift;
	uint16		uiResult;
	uint16		uiDigitOfFirst;
	uint16		uiDigitOfSecond;
	uint16		uiDiffOfDigits;
	CBCDResult	cResult;
	CBCDResult	cBCD8BitResult;

	while (uiShift < 16)
	{
		uiDigitOfFirst = (uiBCDFirst & 0xFF);
		uiDigitOfSecond = (uiBCDSecond & 0xFF);
		cBCD8BitResult = BCDSubtract8Bit(uiDigitOfFirst, uiDigitOfSecond, bBorrow);
		bBorrow = cBCD8BitResult.mbCarry;
		uiResult = uiResult | (cBCD8BitResult.muiValue << uiShift);
		uiShift += 8;
		uiBCDFirst = uiBCDFirst >> uiShift;
		uiBCDSecond = uiBCDSecond >> uiShift;
	}

	cResult.Init(uiResult, bBorrow);
	return cResult;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
uint16 CW65C816State::SetBit(uint16 uiValue, bool bBitValue, uint16 uiBitNumber)
{
	if (bBitValue)
	{
		uiValue = SetBit(uiValue, uiBitNumber);
	}
	else
	{
		uiValue = ClearBit(uiValue, uiBitNumber);
	}
	return uiValue;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
uint16 CW65C816State::ClearBit(uint16 uiValue, uint16 uiBitNumber)
{
	return TrimMemory(uiValue & ~(1 << uiBitNumber));
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
uint16 CW65C816State::SetBit(uint16 uiValue, uint16 uiBitNumber)
{
	return TrimMemory(uiValue | (1 << uiBitNumber));
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CW65C816State::IsBusEnable(void)
{
	return mbBusEnable;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
uint16 CW65C816State::GetData(void)
{
	return muiData;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SetData(uint16 data)
{
	muiData = data;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::PER(void)
{
	muiInternal16BitData = muiInternal16BitData + mcProgramCounter.GetOffset();  // + Carry?
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::PHD(void)
{
	muiInternal16BitData = muiDirectPage;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::PLP(void)
{
	SetProcessorRegisterValue(GetDataLow());
	ProcessorStatusChanged();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::BRK(void)
{
	SetInterruptDisableFlag(true);
	SetDecimalFlag(false);
	if (IsEmulation())
	{
		SetBreakFlag(true);
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::ORA(void)
{
	SetA(GetA() | GetInternal16BitData());
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::TSB(void)
{
	uint16 uiValue;

	uiValue = GetInternal16BitData();
	SetData((uiValue | GetA()), false);
	SetZeroFlag((uiValue & GetA()) == 0);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::TRB(void)
{
	uint16 uiValue;

	uiValue = GetInternal16BitData();
	SetData(uiValue & TrimMemory(~GetA()), false);
	SetZeroFlag((uiValue & GetA()) == 0);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::IncrementA(void)
{
	uint16 a;

	a = TrimMemory(GetA() + 1);
	SetA(a);
	SetSignAndZeroFromMemory(a);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::IncrementX(void)
{
	uint16 x;

	x = TrimIndex(GetX() + 1);
	SetX(x);
	SetSignAndZeroFromIndex(x);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::IncrementY(void)
{
	uint16 y;

	y = TrimIndex(GetY() + 1);
	SetY(y);
	SetSignAndZeroFromIndex(y);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::DecrementA(void)
{
	uint16 a;

	a = TrimMemory(GetA() - 1);
	SetA(a);
	SetSignAndZeroFromMemory(a);
}

void CW65C816State::DecrementY(void)
{
	uint16 y;

	y = TrimIndex(GetY() - 1);
	SetY(y);
	SetSignAndZeroFromIndex(y);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::DecrementX(void)
{
	uint16 x;

	x = TrimIndex(GetX() - 1);
	SetX(x);
	SetSignAndZeroFromIndex(x);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
uint16 CW65C816State::RotateLeft(uint16 uiValue)
{
	bool bCarryWillBeSet;

	bCarryWillBeSet = IsMemoryNegative(uiValue);
	uiValue = TrimMemory(uiValue << 1);
	uiValue = SetBit(uiValue, IsCarrySet(), 0);
	SetCarryFlag(bCarryWillBeSet);
	return uiValue;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
uint16 CW65C816State::RotateRight(uint16 uiValue)
{
	bool bCarryWillBeSet;

	bCarryWillBeSet = (uiValue & 1) != 0;
	uiValue = TrimMemory(uiValue >> 1);
	uiValue = SetBit(uiValue, IsCarrySet(), IsMemory16Bit() ? 15 : 7);
	SetCarryFlag(bCarryWillBeSet);
	return uiValue;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::BIT(void)
{
	uint16 uiValue;

	uiValue = GetInternal16BitData();

	if (IsMemory16Bit())
	{
		SetNegativeFlag(Is16bitValueNegative(uiValue));
		SetOverflowFlag((uiValue & 0x4000) != 0);
		SetZeroFlagFrom16BitValue((uiValue & GetA()));
	}
	else
	{
		SetNegativeFlag(Is8bitValueNegative(uiValue));
		SetOverflowFlag((uiValue & 0x40) != 0);
		SetZeroFlagFrom8BitValue((uiValue & GetA()));
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::BIT_I(void)
{
	if (IsMemory16Bit())
	{
		SetZeroFlagFrom16BitValue((GetInternal16BitData() & GetA()));
	}
	else
	{
		SetZeroFlagFrom8BitValue((GetInternal16BitData() & GetA()));
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::ROR(void)
{
	SetInternal16BitData(RotateRight(GetInternal16BitData()));
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::ROR_A(void)
{
	SetA(RotateRight(GetA()));
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::ROL(void)
{
	SetInternal16BitData(RotateLeft(GetInternal16BitData()));
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::ROL_A(void)
{
	SetA(RotateLeft(GetA()));
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
uint16 CW65C816State::ShiftRight(uint16 uiValue)
{
	SetCarryFlag((uiValue & 1) != 0);
	return TrimMemory(uiValue >> 1);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::LSR(void)
{
	SetInternal16BitData(ShiftRight(GetInternal16BitData()));
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::LSR_A(void)
{
	SetA(ShiftRight(GetA()));
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::ASL(void)
{
	uint16	uiOperand;
	bool	bCarry;

	uiOperand = GetInternal16BitData();
	bCarry = IsMemoryNegative(uiOperand);
	uiOperand = TrimMemory(uiOperand << 1);
	SetCarryFlag(bCarry);
	SetInternal16BitData(uiOperand);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::ASL_A(void)
{
	uint16	uiOperand;
	bool	bCarry;

	uiOperand = GetA();
	bCarry = IsMemoryNegative(uiOperand);
	uiOperand = TrimMemory(uiOperand << 1);
	SetCarryFlag(bCarry);
	SetA(uiOperand);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::TSC(void)
{
	SetA(GetStackPointer());
	SetSignAndZeroFromMemory(GetA());
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::EOR(void)
{
	uint16 uiResult;

	uiResult = TrimMemory(GetA() ^ GetInternal16BitData());
	SetSignAndZeroFromMemory(uiResult);
	SetA(uiResult);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::TCD(void)
{
	SetDirectPage(muiAccumulator);
	SetSignAndZeroFlagFrom16BitValue(muiAccumulator);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::ADC(void)
{
	if (IsMemory16Bit())
	{
		if (!IsDecimal())
		{
			Execute16BitADC();
		}
		else
		{
			Execute16BitBCDADC();
		}
	}
	else
	{
		if (!IsDecimal())
		{
			Execute8BitADC();
		}
		else
		{
			Execute8BitBCDADC();
		}
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::TXA(void)
{
	if (IsMemory8Bit() && IsIndex16Bit())
	{
		SetA(GetLowByte(GetX()));
	}
	else if (IsMemory16Bit() && IsIndex8Bit())
	{
		SetA(SetLowByte(GetA(), GetX()));
	}
	else
	{
		SetA(GetX());
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::LDA(void)
{
	SetA(GetInternal16BitData());
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::LDY(void)
{
	if (IsIndex16Bit())
	{
		SetY(muiInternal16BitData);
	}
	else
	{
		SetY(ToByte(muiInternal16BitData));
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::LDX(void)
{
	if (IsIndex16Bit())
	{
		SetX(muiInternal16BitData);
	}
	else
	{
		SetX(ToByte(muiInternal16BitData));
	}
}


void CW65C816State::TSX(void)
{
	uint16	uiStackPointer;
	uint16	uiStackPointerLower8Bits;

	uiStackPointer = GetStackPointer();
	if (IsIndex8Bit())
	{
		uiStackPointerLower8Bits = GetLowByte(uiStackPointer);
		SetX(SetLowByte(GetX(), uiStackPointerLower8Bits));
	}
	else
	{
		SetX(uiStackPointer);
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::TYA(void)
{
	if (IsMemory8Bit() && IsIndex16Bit())
	{
		SetA(GetLowByte(GetY()));
	}
	else if (IsMemory16Bit() && IsIndex8Bit())
	{
		SetA(SetLowByte(GetA(), GetY()));
	}
	else
	{
		SetA(GetY());
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::TXS(void)
{
	uint16 uiNewStackPointer;

	if (IsEmulation())
	{
		uiNewStackPointer = 0x100 | GetLowByte(GetX());
		SetStackPointer(uiNewStackPointer);
	}
	else
	{
		SetStackPointer(GetX());
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::CPY(void)
{
	uint16 uiValue;

	uiValue = GetIndexData();
	SetSignAndZeroFromIndex(TrimMemory(GetY() - uiValue));
	SetCarryFlag(GetY() >= uiValue);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::CMP(void)
{
	uint16 uiValue;

	uiValue = GetInternal16BitData();
	SetSignAndZeroFromMemory(TrimMemory(GetA() - uiValue));
	SetCarryFlag(GetA() >= uiValue);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::REP(void)
{
	uint16 uiValue;

	uiValue = ToByte(~GetDataLow());
	SetProcessorRegisterValue(GetProcessorRegisterValue() & uiValue);
	ProcessorStatusChanged();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::TAY(void)
{
	uint16	uiLower8BitsOfA;

	if ((IsMemory8Bit() && IsIndex8Bit()) ||
		(IsMemory16Bit() && IsIndex8Bit()))
	{
		uiLower8BitsOfA = GetLowByte(GetA());
		SetY(SetLowByte(GetY(), uiLower8BitsOfA));
	}
	else
	{
		SetY(GetA());
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::TAX(void)
{
	uint16	uiLower8BitsOfA;

	if ((IsMemory8Bit() && IsIndex8Bit()) ||
		(IsMemory16Bit() && IsIndex8Bit()))
	{
		uiLower8BitsOfA = GetLowByte(GetA());
		SetX(SetLowByte(GetX(), uiLower8BitsOfA));
	}
	else
	{
		SetX(GetA());
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::DEC(void)
{
	SetInternal16BitData(TrimMemory(GetInternal16BitData() - 1));
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::INC(void)
{
	SetInternal16BitData(TrimMemory(GetInternal16BitData() + 1));
}



//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::CPX(void)
{
	uint16 uiValue;

	uiValue = GetIndexData();
	SetSignAndZeroFromIndex(TrimMemory(GetX() - uiValue));
	SetCarryFlag(GetX() >= uiValue);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SBC(void)
{
	if (IsMemory16Bit())
	{
		if (!IsDecimal())
		{
			Execute16BitSBC();
		}
		else
		{
			Execute16BitBCDSBC();
		}
	}
	else
	{
		if (!IsDecimal())
		{
			Execute8BitSBC();
		}
		else
		{
			Execute8BitBCDSBC();
		}
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::SEP(void)
{
	uint16 uiValue;

	uiValue = GetDataLow();
	if (IsEmulation())
	{
		uiValue = uiValue & 0xCF;
	}
	SetProcessorRegisterValue(GetProcessorRegisterValue() | uiValue);
	ProcessorStatusChanged();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::XBA(void)
{
	uint16 uiLowerA;
	uint16 uiHigherA;

	uiLowerA = GetLowByte(GetA());
	uiHigherA = GetHighByte(GetA());

	uiLowerA = GetLowByte(GetA());
	uiHigherA = GetHighByte(GetA());
	muiAccumulator = uiHigherA | (uiLowerA << 8);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::XCE(void)
{
	bool bOldCarry;
	bool bOldEmulation;

	bOldCarry = IsCarrySet();
	bOldEmulation = IsEmulation();
	SetEmulationMode(bOldCarry);
	SetCarryFlag(bOldEmulation);

	SetAccumulatorWidthFlag(IsEmulation());
	SetIndexWidthFlag(IsEmulation());
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::Reset(void)
{
	SetEmulationMode(true);
	muiDataBank = 0;
	muiDirectPage = 0;
	mcProgramCounter.SetBank(0);
	SetDecimalFlag(false);
	SetInterruptDisableFlag(true);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::TCS(void)
{
	uint16 uiStackPointer;

	uiStackPointer = GetStackPointer();
	if (IsEmulation())
	{
		uiStackPointer = SetLowByte(uiStackPointer, GetLowByte(GetA()));
	}
	else
	{
		uiStackPointer = GetA();
	}
	SetStackPointer(uiStackPointer);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::AND(void)
{
	SetA((GetA() & GetInternal16BitData()));
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::DoneIfIndex8Bit(void)
{
	if (IsIndex8Bit())
	{
		DoneInstruction();
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::DoneIfIndex16Bit(void)
{
	if (IsIndex16Bit())
	{
		DoneInstruction();
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::DoneIfMemory8Bit(void)
{
	if (IsMemory8Bit())
	{
		DoneInstruction();
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::DoneIfMemory16Bit(void)
{
	if (IsMemory16Bit())
	{
		DoneInstruction();
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::WriteProcessorStatus(void)
{
	SetData(GetProcessorRegisterValue());
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::ReadProcessorStatus(void)
{
	SetProcessorRegisterValue(GetData());
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
uint16 CW65C816State::GetData16BitOffset(void)
{
	uint16 uiDataLow;

	uiDataLow = GetData16Bit();
	if (Is16bitValueNegative(uiDataLow))
	{
		return uiDataLow | 0xffff0000;
	}
	else
	{
		return uiDataLow;
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
uint16 CW65C816State::GetData8BitOffset(void)
{
	uint16 uiDataLow;

	uiDataLow = GetDataLow();
	if (Is8bitValueNegative(uiDataLow))
	{
		return uiDataLow | 0xffffff00;
	}
	else
	{
		return uiDataLow;
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::WriteDataLow(void)
{
	SetData(GetDataLow());
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::WriteDataHigh(void)
{
	SetData(GetDataHigh());
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::ReadOpCode(void)
{
	SetOpCode(GetData());
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CW65C816State::NoteFourX(bool bNextWillRead)
{
	return (GetLowByte(mcAddress.GetOffset()) + GetLowByte(GetX())) > 0xFF ||
		!bNextWillRead ||
		IsIndex16Bit();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CW65C816State::NoteFourY(bool bNextWillRead)
{
	return (GetLowByte(mcAddress.GetOffset()) + GetLowByte(GetY())) > 0xFF ||
		!bNextWillRead ||
		IsIndex16Bit();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CW65C816State::NoteSix(void)
{
	uint16 uiOffset;

	if (IsEmulation())
	{
		uiOffset = mcProgramCounter.GetOffset();
		return AreOffsetsOnDifferentPages(uiOffset, uiOffset + GetData16Bit());
	}
	return false;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
uint16 CW65C816State::GetAddressOffsetX(void)
{
	return ToByte(GetLowByte(mcAddress.GetOffset()) + GetLowByte(GetX()));
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
uint16 CW65C816State::GetAddressOffsetY(void)
{
	return ToByte(GetLowByte(mcAddress.GetOffset()) + GetLowByte(GetY()));
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::WriteProgramBank(void)
{
	SetData(mcProgramCounter.GetBank());
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::WriteProgramCounterHigh(void)
{
	SetData(GetHighByte(mcProgramCounter.GetOffset()));
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CW65C816State::WriteProgramCounterLow(void)
{
	SetData(GetLowByte(mcProgramCounter.GetOffset()));
}

