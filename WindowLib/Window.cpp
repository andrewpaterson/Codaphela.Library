#include "BaseLib/Timer.h"
#include "BaseLib/DebugOutput.h"
#include "StandardLib/ClassDefines.h"
#include "StandardLib/Objects.h"
#include "NativeWindowFactory.h"
#include "WindowTick.h"
#include "Window.h"


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CWindow::Init(const char* szTitle, CNativeWindowFactory* pcFactory, Ptr<CWindowTick> pTick, Ptr<CCanvasDraw> pDraw)
{
	PreInit();

	mszWindowTitle.Init(szTitle);

	mpcFactory = pcFactory;
	mpcNativeWindow = pcFactory->CreateNativeWindow(this);
	CComponent::Init(this);

	mpWindowTick = pTick;
	mpCanvas = OMalloc<CCanvas>(this, CF_R8G8B8, pDraw);
	AddComponent(mpCanvas);
	mbTicking = false;

	mFocus.Init(this);

	PostInit();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CWindow::Free(void)
{
	mpcNativeWindow->GetFactory()->DestroyNativeWindow(mpcNativeWindow);
	mpcNativeWindow = NULL;

	mszWindowTitle.Kill();

	CComponent::Free();

	mpcFactory = NULL;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CWindow::Class(void)
{
	CComponent::Class();

	U_String(mszWindowTitle);

	U_Pointer(mpcNativeWindow);
	M_Pointer(mpCanvas);
	M_Pointer(mpWindowTick);
	U_Bool(mbTicking);
	M_Embedded(mFocus);
	U_Pointer(mpcFactory);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CWindow::Save(CObjectWriter* pcFile)
{
	return false;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CWindow::Load(CObjectReader* pcFile)
{
	return false;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CWindow::Show(void)
{
	bool	bCreated;
	CTimer	cTimer;
	bool	bResult;

	cTimer.Init();
	bCreated = mpcNativeWindow->CreateNativeWindow();
	if (!bCreated)
	{
		return false;
	}

	bResult = true;
	mbTicking = true;
	while (mbTicking)
	{
		cTimer.Update();
		Tick(cTimer.GetUpdateTimeInMillieconds(), cTimer.GetTotalTimeInMillieconds());
		bResult = mpcNativeWindow->ExecuteNativeWindow();
		mbTicking &= bResult;
	}
	return bResult;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CWindow::Paint(void)
{
	Layout();
	Draw();
	mpcNativeWindow->SignalPresent();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CWindow::Layout(void)
{
	CRectangle	cRect;

	mpcNativeWindow->GetRectangle(&cRect);
	SetActualSize(cRect.GetWidth(), cRect.GetHeight());
	SetPosition(0, 0);  //The position of the Window within itself.
	CComponent::Layout(GetPosition(), GetActualSize());

	//mFocus.Update(mcInput.GetPointer()->GetX(), mcInput.GetPointer()->GetY());
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
const char* CWindow::GetWindowTitle(void)
{
	return mszWindowTitle.Text();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CWindow::Tick(int64 iUpdateTimeInMillieconds, int64 iTotalTimeInMillieconds)
{
	mpWindowTick->Tick(this, iUpdateTimeInMillieconds, iTotalTimeInMillieconds);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CWindow::Stop(void)
{
	mbTicking = false;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CWindow::SetContainer(Ptr<CContainer> pContainer)
{
	return mpCanvas->SetContainer(pContainer);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CWindow::ClearContainer(void)
{
	return mpCanvas->ClearContainer();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
Ptr<CCanvas>			CWindow::GetCanvas(void) { return mpCanvas; }
Ptr<CFocus>				CWindow::GetFocus(void) { return &mFocus; }
Ptr<CContainer>			CWindow::GetContainer(void) { return mpCanvas->GetContainer(); }
CNativeWindowFactory*	CWindow::GetFactory(void) { return mpcFactory; }

