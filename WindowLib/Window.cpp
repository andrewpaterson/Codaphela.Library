#include "BaseLib/Timer.h"
#include "BaseLib/DebugOutput.h"
#include "StandardLib/ClassDefines.h"
#include "StandardLib/Objects.h"
#include "NativeWindowFactory.h"
#include "Window.h"


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CWindow::Init(const char* szWindowTitle, CNativeWindowFactory* pcFactory)
{
	PreInit();

	mszWindowTitle.Init(szWindowTitle);

	mpcNativeWindow = pcFactory->CreateNativeWindow(this);
	CBasicComponent::Init(mpcNativeWindow);

	mpCanvas = OMalloc<CCanvas>(pcFactory);

	PostInit();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CWindow::Free(void)
{
	mpcNativeWindow->GetFactory()->DestroyNativeWindow(mpcNativeWindow);
	mpcNativeWindow = NULL;

	mszWindowTitle.Kill();

	CBasicComponent::Free();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CWindow::Class(void)
{
	CBasicComponent::Class();

	U_String(mszWindowTitle);
	U_Pointer(mpcNativeWindow);
	M_Pointer(mpCanvas);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CWindow::Save(CObjectWriter* pcFile)
{
	return false;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CWindow::Load(CObjectReader* pcFile)
{
	return false;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CWindow::Show(void)
{
	bool	bCreated;
	bool	bRunning;
	CTimer	cTimer;

	cTimer.Init();
	bCreated = mpcNativeWindow->CreateNativeWindow();
	if (!bCreated)
	{
		return false;
	}

	bRunning = true;
	while (bRunning)
	{
		cTimer.Update();
		Tick(cTimer.GetUpdateTimeInMillieconds(), cTimer.GetTotalTimeInMillieconds());
		bRunning = mpcNativeWindow->ExecuteNativeWindow();
	}
	return true;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CWindow::CreateCanvas(EColourFormat eFormat, int32 iWidth, int32 iHeight)
{
	CNativeWindowFactory*	pcFactory;
	Ptr<CCanvas>			pNewCanvas;

	pcFactory = mpcNativeWindow->GetFactory();

	pNewCanvas = OMalloc<CCanvas>(eFormat, iWidth, iHeight, pcFactory);

	pNewCanvas->CopyCanvas(mpCanvas);
	CanvasChanged(pNewCanvas);

	mpCanvas = pNewCanvas;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CWindow::DestroyCanvas(void)
{
	mpCanvas = NULL;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CWindow::Paint(void)
{
	mpcNativeWindow->SignalPresent();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
const char* CWindow::GetWindowTitle(void)
{
	return mszWindowTitle.Text();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
Ptr<CCanvas> CWindow::GetCanvas(void) { return mpCanvas;  }

