#include "StandardLib/ClassDefines.h"
#include "Window.h"
#include "Component.h"


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CComponent::Init(Ptr<CWindow> pWindow)
{
	PreInit();

	maChildren.Init();
	msActualSize.Init(0, 0);
	msPosition.Init(0, 0);
	msDesiredSize.Init(-1, -1);
	mbCanGetFocus = false;
	mpParent = NULL;
	mpWindow = pWindow;

	PostInit();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CComponent::Free(void)
{
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CComponent::Class(void)
{
	U_2Int32(msActualSize);
	U_2Int32(msPosition);
	U_2Int32(msDesiredSize);
	U_Bool(mbCanGetFocus);
	M_Pointer(mpParent);
	M_Embedded(maChildren);
	M_Pointer(mpWindow);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CComponent::Save(CObjectWriter* pcFile)
{
	return false;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CComponent::Load(CObjectReader* pcFile)
{
	return false;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CComponent::Draw(void)
{
	return DrawChildren();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CComponent::DrawChildren(void)
{
	size						i;
	Ptr<CComponent>	pComponent;
	bool					bResult;
	size					uiSize;

	uiSize = maChildren.Size();
	for (i = 0; i < uiSize; i++)
	{
		pComponent = maChildren.Get(i);
		bResult = pComponent->Draw();
		if (!bResult)
		{
			return false;
		}
	}
	return true;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CComponent::AddComponent(Ptr<CComponent> pComponent)
{
	maChildren.Add(pComponent);
	pComponent->mpParent = this;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CComponent::RemoveComponent(Ptr<CComponent> pComponent)
{
	return maChildren.Remove(pComponent);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CComponent::RemoveAllComponents(void)
{
	return maChildren.RemoveAll();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
size CComponent::NumComponents(void)
{
	return maChildren.NumElements();
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CComponent::GetContainerBounds(SContainerBounds* psDest)
{
	//The only way the function can be called is if the component is not a container.
	if (mpParent)
	{
		return mpParent->GetContainerBounds(psDest);
	}
	return false;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CComponent::IsPointIn(int x, int y)
{
	//x and y are assumed relative to 'this' component.
	return (((x >= msPosition.x) && (x <= msPosition.x + msActualSize.x)) && ((y >= msPosition.y) && (y <= msPosition.y + msActualSize.y)));
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CComponent::HasFocus(void)
{
	return false;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
Ptr<CComponent> CComponent::FindComponentAt(int x, int y)
{
	size					i;
	Ptr<CComponent>	pcComponent;
	size					uiSize;

	//x and y are assumed relative to 'this' component.
	if (!IsPointIn(x, y))
	{
		return NULL;
	}

	uiSize = maChildren.Size();
	for (i = 0; i < uiSize; i++)
	{
		pcComponent = maChildren.Get(i);
		pcComponent = pcComponent->FindComponentAt(x, y);
		if (pcComponent)
		{
			return pcComponent;
		}
	}

	return this;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CComponent::ToChildSpace(Ptr<CComponent> pcChildComponent, int x, int y, int* px, int* py)
{
	*px = x - pcChildComponent->msPosition.x;
	*py = y - pcChildComponent->msPosition.y;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CComponent::FromChildSpace(Ptr<CComponent> pcChildComponent, int x, int y, int* px, int* py)
{
	*px = x + pcChildComponent->msPosition.x;
	*py = y + pcChildComponent->msPosition.y;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CComponent::Layout(SInt2 sPosition, SInt2 sAreaSize)
{

	SetPosition(sPosition);
	SetActualSize(sAreaSize);

	LayoutChildren(sPosition, sAreaSize);
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CComponent::LayoutChildren(SInt2 sPosition, SInt2 sAreaSize)
{
	size					i;
	Ptr<CComponent>	pComponent;
	size					uiSize;

	uiSize = maChildren.Size();
	for (i = 0; i < uiSize; i++)
	{
		pComponent = maChildren.Get(i);
		pComponent->Layout(sPosition, sAreaSize);
	}
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
size CComponent::GetDepth(void)
{
	size					iDepth;
	Ptr<CComponent>	pcComponent;

	iDepth = 0;
	pcComponent = mpParent;
	while (pcComponent != NULL)
	{
		iDepth++;
		pcComponent = pcComponent->mpParent;
	}
	return iDepth;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
bool CComponent::IsFocussed(void)
{
	if (mpWindow->GetFocus()->GetFocussedComponent() == this)
	{
		return true;
	}
	return false;
}


//////////////////////////////////////////////////////////////////////////
//
//
//////////////////////////////////////////////////////////////////////////
void CComponent::SetActualSize(int fWidth, int fHeight) { msActualSize.Init(fWidth, fHeight); }
void CComponent::SetActualSize(SInt2 sSize) { msActualSize = sSize; }
void CComponent::SetPosition(int x, int y) { msPosition.Init(x, y); }
void CComponent::SetPosition(SInt2 sPosition) { msPosition = sPosition; }
SInt2 CComponent::GetPosition(void) { return msPosition; }
void CComponent::SetDesiredSize(int fWidth, int fHeight) { msDesiredSize.Init(fWidth, fHeight); }
SInt2 CComponent::GetActualSize(void) { return msActualSize; }
SInt2 CComponent::GetDesiredSize(void) { return msDesiredSize; }

